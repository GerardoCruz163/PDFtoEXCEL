<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLA: Factura a Layout</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="pestanas.css?v=1.0">
    <link rel="icon" href="http://localhost:8080/pdfToExcel%20Dic/ResidenciaGera/Imagenes/Imagen AATLASA.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <header id="eBotones" class="divBotones">
        <div class="imagenFondo">
            
        </div>
        <img src="http://localhost:8080/pdfToExcel%20Dic/ResidenciaGera/Imagenes/AATLA_Logo_FObscuros.png" alt="Logo" class="logo">
        <select name="Selecciona un Proveedor" class="listaProveedores" id="proveedorSelect" onchange="cargarDatosSegunProveedor(this.value)"> <!--onchange="cargarDatosSegunProveedor(this.value)"-->
            <option class="elemento" value="">Selecciona un proveedor</option>
            <option class="elemento" value="EDITORIAL JUVENTUD" >EDITORIAL JUVENTUD S.A.</option>
            <option class="elemento" value="NINGBO DYNACO HYDRAULIC">NINGBO DYNACO HYDRAULIC CO., LTD.</option>
            <option class="elemento" value="FINOTEX">FINOTEX</option>
        </select>
        <input class="inputFile1" type="file" id="fileUp-input" onchange="subir()" value="Cargar PDF">
        <button title="Descarga excel" class="btnExcel" onclick="downloadExcel()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5">
                <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                <path d="M7 11l5 5l5 -5"></path>
                <path d="M12 4l0 12"></path>
            </svg>
        </button>
        <div class="enlaceDiv">

            <a title="Informacion" href="./info.html"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="32" height="32" stroke-width="1.5"> <path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0"></path> <path d="M12 9h.01"></path> <path d="M11 12h1v4h1"></path> </svg> </a>
        </div>
    </header>
    
    <div class="contenedor" id="tablaGenerada" style="display: block;">
        <table id="resultadosTable" class="resultadosTable1" border="1">
            <thead>
                <tr>
                    <th>CLAVE PROVEEDOR</th>
                    <th>NO. FACTURA</th>
                    <th>FECHA FACTURA</th>
                    <th>MONTO FACTURA</th>
                    <th>MONEDA</th>
                    <th>INCOTERM</th>
                    <th>SUBDIVISION</th>
                    <th>CERT. ORIGEN</th>
                    <th>NO. PARTE</th>
                    <th>PAIS ORIGEN</th>
                    <th>VENDEDOR</th>
                    <th>FRACCION</th>
                    <th>DESCRIPCION</th>
                    <th>VALOR MERCANCIA</th>
                    <th>UMC</th>
                    <th>CANTIDAD DE UMC</th>
                    <th>CANTIDAD DE UMT</th>
                    <th>REFERENCIA ARANCELARIA</th>
                    <th>Marca</th>
                    <th>Submodelo</th>
                    <th>No. Serie</th>
                    <th>VALORACION</th>
                    <th>TIPO DE MERCAN</th>
                    <th>VINCULACION</th>
                </tr>
            </thead>
            <tbody id="resultadosBody"></tbody>
        </table>
    </div>

    <!-- <div class="window-notice" id="window-notice">
        <div class="content">
            <div class="content-text">NOTA: El sitio contiene Inteligencia Artificial, si hay algun dato incompleto puedes descargar el archivo excel y modificarlo. 
            <a href="#">Leer más.</a></div>
            <div class="content-buttons"><a href="#" id="close-button">Aceptar</a></div>
        </div>
    </div> -->

    <script>
        function formatPrice(number) {
            return parseFloat(number).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
        }

        function cargarDatosSegunProveedor(proveedor) {
            fetch('./Backend/ResponseJSON/PDF_EXPORT.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('ERROR de Respuesta');
                }
                return response.json();
            })
            .then(jsonData => {
                if (proveedor === "EDITORIAL JUVENTUD") {
                    console.log("Formato VER106");
                    cveProveedor = 'VER106';
                    const tbody = document.getElementById('resultadosBody');
                    tbody.innerHTML = ''; // Limpia la tabla antes de insertar datos
                    const regexFecha = /\b\d{4}-\d{2}-\d{2}\b/;
                    const numeroFactura = jsonData.invoice_number;
                    const fechaFactura = jsonData.date.match(regexFecha)
                    const totalMonto = formatPrice(jsonData.total);
                    const moneda = jsonData.currency_code;
                    let valoresMercancia = [];
                    let cantidadUMC = [];
                    
                    jsonData.line_items.forEach((item)=>{
                        let cantidad = item.quantity;
                        let valoresMerc = formatPrice(item.total);
                        cantidadUMC.push(cantidad);
                        valoresMercancia.push(valoresMerc);
                    })
                    const promesas = jsonData.line_items.map((item) => {
                        const texto = item.text || '';
                        const coincidencias = texto.match(/\b\d{5,14}\b/g);
                        const numerosParte = coincidencias ? coincidencias[coincidencias.length - 1] : null;
                        
                        //console.log('valor mercancia ', valoresMercancia, '\numc ',cantidadUMC);
                        /*if (!numerosParte) {
                            return Promise.resolve([]); // No se encontraron números de parte
                        }*/
                
                        return fetch(`http://localhost:8081/data`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ cveProveedor, text: numerosParte }),
                        })
                        .then((response) => {
                            if (!response.ok) throw new Error('Error en la respuesta del servidor');
                            return response.json();
                        })
                        .catch((error) => {
                            console.error('Error al obtener los datos:', error);
                            return [];
                        });
                    });
                
                    Promise.all(promesas)
                        .then((resultados) => {
                            const todosLosResultados = [].concat(...resultados);
                
                            todosLosResultados.forEach((row, index) => {
                                const tr = document.createElement('tr');
                                const colorFracc = row.NUM_FRACC ? 'bsackground-color: #abebc6;' : 'background-color: #f1948a;';
                                
                                tr.innerHTML = `
                                    <td>${cveProveedor || 'No disponible'}</td>
                                    <td>${numeroFactura || 'No disponible'}</td>
                                    <td>${fechaFactura || 'No disponible'}</td>
                                    <td>$ ${totalMonto || 'No disponible'}</td>
                                    <td>${moneda || 'No disponible'}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${row.NUM_PART || 'No disponible'}</td>
                                    <td></td>
                                    <td>ESP</td>
                                    <td style="${colorFracc}">${row.NUM_FRACC || ''}</td>
                                    <td>${row.DES_MERC || 'No disponible'}</td>
                                    <td>$ ${valoresMercancia[index]}</td>
                                    <td>${''}</td>
                                    <td>${cantidadUMC[index]}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${row.IMP_EXPO || 'No disponible'}</td>
                                    <td>${row.EDO_MERC || 'No disponible'}</td>
                                    <td>${row.CVE_VINC || 'No disponible'}</td>
                                `;
                                tbody.appendChild(tr);
                            });
                
                            if (todosLosResultados.length === 0) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td colspan="24">No se encontraron resultados.</td>`;
                                tbody.appendChild(tr);
                            }
                        })
                        .catch((error) => {
                            console.error('Error al procesar los resultados:', error);
                        });
                }else if(proveedor == "NINGBO DYNACO HYDRAULIC"){
                    console.log("Formato TON23")
                    const tbody = document.getElementById('resultadosBody');
                    tbody.innerHTML = ''; // Limpia la tabla antes de insertar datos
                    const regexFecha = /\b\d{4}-\d{2}-\d{2}\b/;
                    let cveProveedor = 'TON23'
                    const numeroFactura = jsonData.invoice_number;
                    const fechaFactura = jsonData.date.match(regexFecha);
                    const totalMonto = formatPrice(jsonData.total);
                    const moneda = jsonData.currency_code;
                    
                    let valoresMercancia = [];
                    let cantidadUMC = [];
                    
                    jsonData.line_items.forEach((item)=>{
                        let cantidad = item.quantity;
                        let valoresMerc = formatPrice(item.total);
                        cantidadUMC.push(cantidad);
                        valoresMercancia.push(valoresMerc);
                    })

                    const promesas = jsonData.line_items.map((item) => {
                        const texto = item.text || '';
                        // Ajuste: Extraer contenido entre el primer y segundo '\t'
                        const regexNumeroParte = /^[^\t]*\t([^\t]+?)\t/;
                        const coincidencia = texto.match(regexNumeroParte);
                        const numeroParte = coincidencia ? coincidencia[1].replace(/\s+/g, '') : null;
                        
                        console.log(numeroParte);
                
                        return fetch(`http://localhost:8081/data`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ cveProveedor, text: numeroParte }),
                        })
                        .then((response) => {
                            if (!response.ok) throw new Error('Error en la respuesta del servidor');
                            return response.json();
                        })
                        .catch((error) => {
                            console.error('Error al obtener los datos:', error);
                            return [];
                        });
                    });

                    Promise.all(promesas)
                        .then((resultados) => {
                            const todosLosResultados = [].concat(...resultados);
                
                            todosLosResultados.forEach((row, index) => {
                                const tr = document.createElement('tr');
                                const colorFracc = row.NUM_FRACC ? 'bsackground-color: #abebc6;' : 'background-color: #f1948a;';
                                
                                tr.innerHTML = `
                                <td>${cveProveedor}</td>
                                <td>${numeroFactura}</td>
                                <td>${fechaFactura}</td>
                                <td>$ ${totalMonto}</td>
                                <td>${moneda}</td>
                                <td>${''}</td>
                                <td>${''}</td>
                                <td>${''}</td>
                                <td>${row.NUM_PART || 'No Disponible'}</td>
                                <td>${''}</td>
                                <td>CHN</td>
                                <td style="${colorFracc}">${row.NUM_FRACC || 'No Disponible'}</td>
                                <td>${row.DES_MERC || 'No Disponible'}</td>
                                <td>$ ${valoresMercancia[index]}</td>
                                <td>${''}</td>
                                <td>${cantidadUMC[index]}</td>
                                <td>${''}</td>
                                <td>${''}</td>
                                <td>${''}</td>
                                <td>${''}</td>
                                <td>${''}</td>
                                <td>${row.IMP_EXPO || 'No disponible'}</td>
                                <td>${row.EDO_MERC || 'No disponible'}</td>
                                <td>${row.CVE_VINC || 'No disponible'}</td>
                            `;
                            tbody.appendChild(tr);
                            });
                
                            if (todosLosResultados.length === 0) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td colspan="24">No se encontraron resultados.</td>`;
                                tbody.appendChild(tr);
                            }
                        })
                        .catch((error) => {
                            console.error('Error al procesar los resultados:', error);
                        });
                }else if(proveedor == "FINOTEX"){
                    console.log("Formato FINOTE")
                    cveProveedor = 'FINOTE';
                    const tbody = document.getElementById('resultadosBody');
                    tbody.innerHTML = ''; // Limpia la tabla antes de insertar datos
                    const regexFecha = /\b\d{4}-\d{2}-\d{2}\b/;
                    const numeroFactura = jsonData.invoice_number;
                    const fechaFactura = jsonData.date.match(regexFecha)
                    const totalMonto = formatPrice(jsonData.total);
                    const moneda = jsonData.currency_code;
                    let valoresMercancia = [];
                    let cantidadUMC = [];
                    
                    jsonData.line_items.forEach((item)=>{
                        let cantidad = item.quantity;
                        let valoresMerc = formatPrice(item.total);
                        cantidadUMC.push(cantidad);
                        valoresMercancia.push(valoresMerc);
                    })
                    const promesas = jsonData.line_items.map((item) => {
                        const texto = item.text || '';
                        const coincidencia = texto.match(/\bHS-\d{6}\b/); 
                        const numerosParte = coincidencia ? coincidencia[0] : null; //Obtengo el primer numero que enuentre
                        
                        //console.log('valor mercancia ', valoresMercancia, '\numc ',cantidadUMC);
                        /*if (!numerosParte) {
                            return Promise.resolve([]); // No se encontraron números de parte
                        }*/
                
                        return fetch(`http://localhost:8081/data`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ cveProveedor, text: numerosParte }),
                        })
                        .then((response) => {
                            if (!response.ok) throw new Error('Error en la respuesta del servidor');
                            return response.json();
                        })
                        .catch((error) => {
                            console.error('Error al obtener los datos:', error);
                            return [];
                        });
                    });
                
                    Promise.all(promesas)
                        .then((resultados) => {
                            const todosLosResultados = [].concat(...resultados);
                
                            todosLosResultados.forEach((row, index) => {
                                const tr = document.createElement('tr');
                                const colorFracc = row.NUM_FRACC ? 'bsackground-color: #abebc6;' : 'background-color: #f1948a;';
                                
                                tr.innerHTML = `
                                    <td>${cveProveedor || 'No disponible'}</td>
                                    <td>${numeroFactura || 'No disponible'}</td>
                                    <td>${fechaFactura || 'No disponible'}</td>
                                    <td>$ ${totalMonto || 'No disponible'}</td>
                                    <td>${moneda || 'No disponible'}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${row.NUM_PART || 'No disponible'}</td>
                                    <td></td>
                                    <td>SLV</td>
                                    <td style="${colorFracc}">${row.NUM_FRACC || ''}</td>
                                    <td>${row.DES_MERC || 'No disponible'}</td>
                                    <td>$ ${valoresMercancia[index]}</td>
                                    <td>${''}</td>
                                    <td>${cantidadUMC[index]}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${''}</td>
                                    <td>${row.IMP_EXPO || 'No disponible'}</td>
                                    <td>${row.EDO_MERC || 'No disponible'}</td>
                                    <td>${row.CVE_VINC || 'No disponible'}</td>
                                `;
                                tbody.appendChild(tr);
                            });
                
                            if (todosLosResultados.length === 0) {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td colspan="24">No se encontraron resultados.</td>`;
                                tbody.appendChild(tr);
                            }
                        })
                        .catch((error) => {
                            console.error('Error al procesar los resultados:', error);
                        });
                }
            })
            .catch(error => {
                console.error('Error al leer el archivo JSON:', error);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const fileInput = document.getElementById("fileUp-input");
            const proveedorSelect = document.getElementById("proveedorSelect");
    
            // Deshabilitar el campo de carga de archivos al cargar la página
            fileInput.disabled = true;
    
            // Habilitar el campo de carga cuando se selecciona un proveedor
            proveedorSelect.addEventListener("change", function () {
                fileInput.disabled = !proveedorSelect.value; // Solo habilita si hay un proveedor seleccionado
            });
        });
    
        function subir() {
            const fileInput = document.getElementById("fileUp-input");
            const proveedorSelect = document.getElementById("proveedorSelect");
            const barraContenedor = document.getElementById("barraContenedor");
            
            const proveedor = proveedorSelect.value;
            const file = fileInput.files[0];
    
            if (!proveedor) {
                alert("Por favor, selecciona un proveedor antes de subir el archivo.");
                return;
            }

            
            // Subir el archivo
            const formData = new FormData();
            formData.append('file', file);
    
            fetch('http://localhost:8081/upload', {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log("ESTADO:", data);
                setTimeout(() => {
                    cargarDatosSegunProveedor(proveedor);
                }, 30000);
            })
            .catch(error => {
                console.error("Error al subir el archivo:", error);
                barraContenedor.style.display = "none";
                mensajeSubiendo.style.display = "none";
            });
        }
    </script>

    <script>
        function htmlToExcelXLSX(idTabla, nombreArchivo = 'archivo.xlsx') {
            const tabla = document.getElementById(idTabla);
            if (!tabla) {
                alert('La tabla no tiene datos, por favor, importa un PDF.');
                return;
            }

            // Convierte las filas de la tabla en un arreglo de arreglos (AOA)
            const filas = Array.from(tabla.querySelectorAll('tr')).map(fila =>
                Array.from(fila.querySelectorAll('th, td')).map(celda => celda.innerText.trim())
            );

            // Crea el libro y la hoja de trabajo
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(filas);

            // Aplica estilos a los encabezados (primera fila)
            const encabezados = filas[0]; // Primera fila (encabezados)
            encabezados.forEach((_, index) => {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: index }); // Fila 0, columna `index`
                if (!worksheet[cellAddress]) return;
                
                worksheet[cellAddress].s = {
                    font: {
                        bold: true,
                        color: { rgb: "4169E1" } // Color del texto blanco
                    },
                    fill: {
                        patternType: "solid", // Asegura un color de fondo sólido
                        fgColor: { rgb: "4CAF50" } // Color de fondo verde
                    },
                    alignment: {
                        horizontal: "center", // Centrado horizontal
                        vertical: "center" // Centrado vertical
                    },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } },
                    }
                };
            });

            // Agrega la hoja al libro y descarga
            XLSX.utils.book_append_sheet(workbook, worksheet, "Layout de Factura");
            XLSX.writeFile(workbook, nombreArchivo);
        }

        function downloadExcel() {
            let now = new Date();
            let formattedDate = now.toISOString().slice(0, 10);
            let formattedTime = now.toTimeString().slice(0, 8).replace(/:/g, '-');
            let timestamp = `${formattedDate}_${formattedTime}`;
            let fileName = `layout_${timestamp}.xlsx`;
            htmlToExcelXLSX('resultadosTable', fileName);
        }
        
    </script>
    <div class = "creditos">
        <div class="creditos-texto">
            
            © 2025 Verify OCR. Utiliza el servicio de Verify OCR Invoices. Departamento de Sistemas, Tecno Logistica Aduanal S.A de C.V, Nuevo Laredo, Tamps.
    </div>
</body>
</html>
