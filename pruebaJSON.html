<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ELEMENTOS JSON</title>
  <link rel="stylesheet" href="pestanas.css?v=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .text-item {
      margin-bottom: 10px;
    }
    .text-item p {
      margin: 0;
    }

    
  </style>
</head>
<body>
    <div class="encabezado">
        
    </div>
    <div class = "botonesDiv">
        <select name="Selecciona un Proveedor" class = "listaProveedores">
            <option value="">Selecciona un proveedor</option>
            <option value="EDITORIAL JUVENTUD">EDITORIAL JUVENTUD S.A.</option>
        </select><br>
        <input class="inputFile1" type="file" id="fileUp-input" onchange="subir()" value="Cargar PDF" multiple>
        <br>
        <button class= "btnExcel" onclick = "downloadExcel()"><img src="https://images.vexels.com/media/users/3/157561/isolated/preview/5077aba5e425c55dff227a93b655da7b-icono-de-descarga-simple.png">Descargar en xls (Excel)</button>
    </div>

    <div class="contenido">
        <div id="text-output"></div>
        <script>

            fetch('http://localhost:8081/data') // Cambia esta ruta por la de tu servidor
            .then(response => response.json())
            .then(data => {
                const resultadosPre = document.getElementById('resultados');
                
                // Convertimos el JSON en una cadena de texto con formato
                const textoResultado = JSON.stringify(data, null, 2); // Formateamos el JSON con sangría de 2 espacios
                
                // Mostramos el JSON en el <pre>
                resultadosPre.textContent = textoResultado;
                
            })
            .catch(error => {
                console.error('Error al obtener los datos:', error);
            });
          //cargar el json
          fetch('./Backend/PDF_EXPORT.json')
          .then(response => {
              if (!response.ok) {
                  throw new Error('ERROR de Respuesta');
              }
              return response.json();
          })
          .then(jsonData => {
              const textOutputDiv = document.getElementById('text-output');
      
              if (jsonData && jsonData.elements) {
                  let claveProveedor = 'TON23';
                  let headers = ['CLAVE PROVEEDOR', 'NO. FACTURA', 'FECHA FACTURA', 'MONTO FACTURA', 'MONEDA', 'INCOTERM', 
                  'SUBDIVISION', 'CERT. ORIGEN', 'NUMERO DE PARTE', 'PAIS ORIGEN','FRACCION', 'DESCRIPCION', 'CANTIDAD', 
                  'PRECIO (USD)', 'VALOR DE LA MERCANCIA', 'UMC', 'CANTIDAD DE UMC', 'CANTIDAD DE UMT', 'MARCA', 'SUBMODELO', 
                  'NO. SERIE','VALORACION', 'TIPO DE MERCAN', 'VINCULACION'];
                  let rows = [];
                  let currentRow = {
                      'CLAVE PROVEEDOR': claveProveedor,
                      'No.Factura': '',
                      'Fecha Factura': '',
                      'MONEDA': '',
                      'INCOTERM': ''
                  };
                  let invoiceNo = '';
                  let numFactura = '';
                  let fechaFactura = '';
                  let fechaMod = '';
                  let moneda = '';
                  let monMod = '';
                  let incoterm = '';
                  let numFraccion = "0000000000";
      
                  jsonData.elements.forEach((elementoNP) =>{
                    numParte = elementoNP.Text;

                  });

                  jsonData.elements.forEach((ciertoElemento) =>{
                      texto = ciertoElemento.Text || '';
                      if(texto.includes('CIF')){
                          incoterm = texto;
                      }
                  });
      
                  //recorrido del JSON
                  jsonData.elements.forEach((element, index) => {
                      let text = element.Text || '';
                      let path = element.Path || '';
                      
                      if (text.includes("NINGBO DYNACO HYDRAULIC CO., LTD.") ||
                          text.includes("HUILONG INDUSTRIAL ZONE 39,YIWU, JINHUA, ZHEJIANG PROVINCE, CHINA") ||
                          text.includes("TAX ID:") ||
                          text.includes("Commercial Invoice") ||
                          text.includes("To:") ||
                          text.includes("Attn:")) {
                          return;
                      }
                      
                      if (path === '//Document/Sect[2]/P[3]/Sub') {
                          invoiceNo = text;
                          numFactura = invoiceNo.slice(12);
                          currentRow['No.Factura'] = numFactura;
                      }
                      if (path === '//Document/Sect[2]/P[3]/Sub[3]') {
                          fechaFactura = text;
                          fechaMod = fechaFactura.slice(9);
                          currentRow['Fecha Factura'] = fechaMod;
                      }
                      if (path.includes(`//Document/Sect[`) && path.includes(`]/Table/TR/TH[`) && path.includes(`]/P`) && text.includes('USD')) {
                          moneda = text;
                          monMod = moneda.slice(8, moneda.length - 2);
                          currentRow['MONEDA'] = monMod;
                      }
                      
                      if (path.includes(`]/TD[2]/P`) && !text.includes('CIF')) {
                          currentRow['Description'] = text;
                      } else if (path.includes(`]/TD[3]/P`)) {
                          currentRow['NUMERO DE PARTE'] = text;
                      } else if (path.includes(`]/TD[4]/P`) && !text.includes('PCS')) {
                          currentRow['Quantity'] = text;
                      } else if (path.includes(`]/TD[5]/P`)) {
                          currentRow['PRECIO (USD)'] = text;
                      } else if (path.includes(`]/TD[6]/P`)) {
                          currentRow['VALOR DE LA MERCANCIA'] = text;
                      }
                      
                      currentRow['INCOTERM'] = incoterm;
                      currentRow['FRACCION'] = numFraccion;
      
                      if (index === jsonData.elements.length - 1 || path.includes(`]/TD[6]/P`)) {
                          rows.push(currentRow);
                          currentRow = {
                              'CLAVE PROVEEDOR': claveProveedor,
                              'No.Factura': numFactura,
                              'Fecha Factura': fechaMod,
                              'MONEDA': monMod,
                              'INCOTERM': incoterm
                          };
                      }
                  });
      
                  let tableHTML = `
                  <div class = "tablaD">
                      <table id="dataTable" class="tablaDatos">
                          <thead>
                              <tr>
                                  ${headers.map(header => `<th>${header}</th>`).join('')}
                              </tr>
                          </thead>
                          <tbody>
                  `;
      
                  rows.forEach(row => {
                      tableHTML += `
                          <tr>
                              ${headers.map(header => `<td>${row[header] || ''}</td>`).join('')}
                          </tr>
                        </div>
                      `;
                  });
      
                  tableHTML += `
                          </tbody>
                      </table>
                  `;
      
                  textOutputDiv.innerHTML = tableHTML;
              } else {
                  textOutputDiv.innerHTML = '<p>No hay elementos que mostrar</p>';
              }
          })
          .catch(error => {
              console.error('Error fetching JSON:', error);
              document.getElementById('text-output').innerHTML = '<p>Error al cargar el JSON</p>';
          });
      
            // Función para descargar la tabla como Excel
          function htmlExcel(idTabla, nombreArchivo = '') {
            let linkDescarga;
            let tipoDatos = 'application/vnd.ms-excel';
            let tablaDatos = document.getElementById(idTabla);
            let tablaHTML = tablaDatos.outerHTML;
            
            tablaHTML = tablaHTML.replace(/<th>/g, '<th style="background-color: blue; color: white; border: 1px solid rgb(255, 255, 255); height: 40px;">');
            
            // Aplicar formato de texto a todas las celdas
            tablaHTML = tablaHTML.replace(/<td>([^<]*)<\/td>/g, function(match, p1) {
              // Si la celda es un número de 8 dígitos con ceros, agregar el formato de texto
              if (/^0{10}$/.test(p1)) {
                  return '<td style="mso-number-format:\'\\@\';">' + p1 + '</td>';
              } else {
                  return '<td>' + p1 + '</td>';
              }
              });
      
            tablaHTML = tablaHTML.replace(/ /g, '%20');
            // Nombre del archivo
            nombreArchivo = nombreArchivo ? nombreArchivo + '.xls' : 'archivo.xlsx';
      
            // Crear el link de descarga
            linkDescarga = document.createElement("a");
      
            document.body.appendChild(linkDescarga);
      
            if (navigator.msSaveOrOpenBlob) {
              let blob = new Blob(['\ufeff', tablaHTML], {
                type: tipoDatos
              });
              navigator.msSaveOrOpenBlob(blob, nombreArchivo);
            } else {
              // Crear el link al archivo
              linkDescarga.href = 'data:' + tipoDatos + ', ' + tablaHTML;
      
              // Setear el nombre de archivo
              linkDescarga.download = nombreArchivo;
      
              //Ejecutar la función
              linkDescarga.click();
            }
          }
      
          function downloadExcel() {
            htmlExcel('dataTable', 'Datos_JSON');
          }

          function subir(){
            var i=document.getElementById('fileUp-input');
         
            if(window.FileReader){
                for(var j=0;j<i.files.length;j++){//como mi input file es múltiple, recorro sus elementos (archivos) que pueden ser varios
                    var reader = new FileReader();//instanciamos FileReader
                    reader.onloadend = (function(f){//creamos la función que recogerá los datos
                        console.log("Contenido de e.target.result:", e.target.result); // Para ver qué hay en e.target.result
                    if (e.target.result.includes(",")) { // Verifica si hay una coma en el resultado
                        var content = e.target.result.split(",", 2)[1];
                        console.log("Contenido codificado en base64:", content);
                    } else {
                        console.error("El archivo no tiene el formato esperado.");
                    }
                    })(i.files[j]);
                    reader.readAsDataURL(i.files[j]);//
                }
            }
        }

        </script>

        <script>
            function subir() {
                const fileInput = document.getElementById('fileUp-input');
                const file = fileInput.files[0];
        
                if (!file) {
                    alert('Por favor, selecciona un archivo.');
                    return;
                }
        
                const formData = new FormData();
                formData.append('pdfFile', file);
        
                fetch('http://localhost:8081/upload', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    console.log("Codigo HTTP: ", response.status);
                    if (!response.ok) {
                        throw new Error('Error en la carga del archivo.'); //aqui marca el error
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data.message);
                    alert('Archivo subido y procesado exitosamente.');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al subir el archivo.');
                });
            }

            function checkServerAndUpload() {
                // Verificar si el servidor está corriendo
                fetch('http://localhost:8081/ping') // Ruta para probar si el servidor está activo
                    .then(response => {
                        if (response.ok) {
                            // Si el servidor está activo, sube el archivo
                            subir();
                        } else {
                            throw new Error('Servidor no activo.');
                        }
                    })
                    .catch(() => {
                        // Si el servidor no está activo, intenta iniciarlo y luego subir el archivo
                        startServerAndUpload();
                    });
            }
            
            function startServerAndUpload() {
                // Llamar a un servicio externo o script que inicie el servidor
                fetch('http://localhost:8081/start-server') // Ajusta este endpoint según tu setup
                    .then(() => {
                        // Esperar unos segundos para que el servidor arranque
                        setTimeout(() => {
                            // Subir el archivo después de que el servidor se haya iniciado
                            subir();
                        }, 5000); // Ajusta el tiempo de espera según lo necesario
                    })
                    .catch(error => {
                        console.error('Error al iniciar el servidor:', error);
                    });
            }
        </script>  

        
    </div> 

    <div class = "creditos">
        <img src="/Imagenes/ADBE_BIG.D-dedf7ea0.png" alt="Logo del sitio">
        <div class="creditos-texto">
        Este sitio utiliza el servicio de Adobe Services. Departamento de Sistemas, Tecno Logistica Aduanal S.A de C.V. - © 2024 Adobe Services.
    </div>
    </div>
</body>
</html>

